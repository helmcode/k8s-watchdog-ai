services:
  # K8s Watchdog AI - Main application
  watchdog:
    build: .
    container_name: k8s-watchdog-ai
    environment:
      # Claude Code Configuration
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-sonnet-4-20250514}
      - CLAUDE_MAX_TURNS=${CLAUDE_MAX_TURNS:-25}
      - CLAUDE_TIMEOUT=${CLAUDE_TIMEOUT:-300}

      # MCP Configuration
      - PROMETHEUS_URL=${PROMETHEUS_URL:-http://host.docker.internal:9090}
      - KUBECONFIG_PATH=/home/watchdog/.kube/config

      # Cluster Configuration
      - CLUSTER_NAME=local
      - CLIENT_NAME=prueba
      - NAMESPACES_EXCLUDE=kube-system,kube-public,kube-node-lease

      # Report Configuration
      - REPORT_LANGUAGE=spanish

      # Slack Configuration
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_CHANNEL=${SLACK_CHANNEL:-}

      # Storage
      - DATA_DIR=/app/data
      - RETENTION_WEEKS=2

      # Logging
      - LOG_LEVEL=INFO
    volumes:
      - ./data:/app/data
      - ~/.kube/config:/home/watchdog/.kube/config:ro
    ports:
      - "8000:8000"
    networks:
      - watchdog-network
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  watchdog-network:
    driver: bridge
